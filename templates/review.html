{% extends "layout.html" %}

{% block title %}Revisar Proposta{% endblock %}

{% block content %}
    <h1>Revisar e Editar Proposta</h1>
    <h2 style="color: var(--cor-texto-secundario); font-size: 1.5rem;">Cliente: {{ nome_cliente }}</h2>

    <form action="/criar_pdf" method="post" id="review-form">
        <input type="hidden" name="nome_cliente" value="{{ nome_cliente }}">
        
        <!-- Secção 1: Análise do Projeto -->
        <div class="form-group">
            <h2>Análise do Projeto</h2>
            <textarea id="analise_projeto" name="analise_projeto">{{ proposta.analise_projeto }}</textarea>
        </div>

        <!-- Secção 2: Itens da Proposta -->
        <div class="form-group">
            <h2>Itens da Proposta</h2>
            <table id="products-table">
                <thead>
                    <tr>
                        <th>Produto</th>
                        <th>Quantidade</th>
                        <th>Preço Unit. (R$)</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="products-tbody">
                    {% for item in proposta.itens_proposta %}
                    <tr class="product-row">
                        <td>
                            <select name="produto" class="product-select" data-selected="{{ item.produto }}" onchange="updatePrice(this)">
                                {% for produto_catalogo in catalogo_completo %}
                                    <option value="{{ produto_catalogo.Produto }}" data-price="{{ produto_catalogo.VENDA }}">
                                        {{ produto_catalogo.Produto }}
                                    </option>
                                {% endfor %}
                            </select>
                        </td>
                        <td><input type="number" name="quantidade" value="{{ item.quantidade }}" min="1"></td>
                        <td><input type="number" step="0.01" name="preco_unitario" value="{{ item.preco_unitario }}" class="price-input"></td>
                        <td class="actions-cell">
                            <button type="button" class="button button-danger button-small" onclick="deleteRow(this)">Excluir</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <button type="button" class="button button-secondary" onclick="addRow()" style="margin-top: 15px;">Adicionar Produto</button>
        </div>

        <!-- Secção 3: Editor de Plantas -->
        <div class="form-group">
            <h2>Editor de Planta</h2>
            <div class="editor-container">
                <div class="paleta-ferramentas">
                    <h3>Ferramentas</h3>
                    <div class="simbolo simbolo-redondo" title="Caixa Redonda" onclick="selectSymbol('redonda')"></div>
                    <div class="simbolo simbolo-quadrado" title="Caixa Quadrada" onclick="selectSymbol('quadrada')"></div>
                    <div class="simbolo simbolo-retangular" title="Caixa de Sobrepor" onclick="selectSymbol('retangular')"></div>
                    <button type="button" class="button button-warning button-small" onclick="undoLastAction()" style="margin-top: 15px;">Desfazer</button>
                    <button type="button" class="button button-danger button-small" onclick="clearDrawings()" style="margin-top: 5px;">Limpar</button>
                </div>

                {% if imagem_planta_url %}
                <div class="planta-wrapper">
                    <img id="planta-imagem" src="{{ imagem_planta_url }}" alt="Planta do cliente">
                    <canvas id="planta-canvas"></canvas>
                </div>
                {% else %}
                <p>Nenhuma planta foi enviada para este projeto.</p>
                {% endif %}
            </div>
        </div>
        
        <input type="hidden" name="imagem_desenhada" id="imagem_desenhada">

        <div class="actions">
            <button type="button" class="button button-primary button-full-width" onclick="submitForm()">Gerar PDF Final</button>
        </div>
    </form>
{% endblock %}

{% block scripts %}
    <script>
        // Transforma a lista de produtos do Python numa variável JavaScript
        const catalogo = {{ catalogo_completo | tojson }};

        function updatePrice(selectElement) {
            // Atualiza o preço quando um produto é selecionado
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const price = selectedOption.getAttribute('data-price');
            const priceInput = selectElement.closest('.product-row').querySelector('.price-input');
            if (price) { priceInput.value = price; }
        }
        
        function addRow() {
            // Cria uma nova linha na tabela
            const tableBody = document.getElementById('products-tbody');
            const newRow = document.createElement('tr');
            newRow.classList.add('product-row');
            
            let innerHTML = `
                <td>
                    <select name="produto" class="product-select" onchange="updatePrice(this)">
                        <option value="">-- Selecione um produto --</option>
                        ${catalogo.map(p => `<option value="${p.Produto}" data-price="${p.VENDA}">${p.Produto}</option>`).join('')}
                    </select>
                </td>
                <td><input type="number" name="quantidade" value="1" min="1"></td>
                <td><input type="number" step="0.01" name="preco_unitario" value="0.00" class="price-input"></td>
                <td class="actions-cell"><button type="button" class="button button-danger button-small" onclick="deleteRow(this)">Excluir</button></td>
            `;
            
            newRow.innerHTML = innerHTML;
            tableBody.appendChild(newRow);
        }

        function deleteRow(button) {
            // Apaga a linha da tabela
            const row = button.closest('.product-row');
            row.remove();
        }

        // --- CÓDIGO JAVASCRIPT DO EDITOR DE PLANTAS (com "Desfazer") ---
        let canvas, ctx, selectedSymbol = null;
        let simboloTamanho = 10;
        let drawingHistory = [];
        const imagem = document.getElementById('planta-imagem');

        document.addEventListener('DOMContentLoaded', function() {
            // Lógica de pré-seleção da tabela
            document.querySelectorAll('.product-select').forEach(select => {
                const selectedValue = select.getAttribute('data-selected');
                if (selectedValue) {
                    select.value = selectedValue;
                    if (select.value !== selectedValue) {
                        for (let i = 0; i < select.options.length; i++) {
                            if (select.options[i].value.trim() === selectedValue.trim()) {
                                select.selectedIndex = i;
                                break;
                            }
                        }
                    }
                }
            });
            // Inicializa o editor
            initEditor();
        });
        
        function initEditor() {
            canvas = document.getElementById('planta-canvas');
            if (!canvas || !imagem) return;
            ctx = canvas.getContext('2d');
            
            // Garante que a imagem esteja carregada para pegar o tamanho certo
            imagem.onload = () => {
                canvas.width = imagem.clientWidth;
                canvas.height = imagem.clientHeight;
                simboloTamanho = Math.max(canvas.width / 100, 8);
                console.log(`Editor de planta inicializado. Tamanho do canvas: ${canvas.width}x${canvas.height}`);
            };
            if (imagem.complete) {
                imagem.onload();
            }
            
            canvas.addEventListener('click', handleDraw);
        }
        function selectSymbol(tipo) {
            selectedSymbol = tipo;
            console.log(`Ferramenta selecionada: ${tipo}`);
            document.querySelectorAll('.simbolo').forEach(s => s.classList.remove('selected'));
            document.querySelector(`.simbolo-${tipo}`).classList.add('selected');
        }
        function handleDraw(event) {
            if (!selectedSymbol) {
                alert("Por favor, selecione uma ferramenta da paleta primeiro.");
                return;
            }
            const x = event.offsetX;
            const y = event.offsetY;
            drawingHistory.push({ type: selectedSymbol, x: x, y: y, size: simboloTamanho });
            redrawCanvas();
        }
        function redrawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#FF0000A0";
            ctx.strokeStyle = "#000000";
            ctx.lineWidth = 2;
            for (const action of drawingHistory) {
                ctx.beginPath();
                if (action.type === 'redonda') {
                    ctx.arc(action.x, action.y, action.size, 0, 2 * Math.PI);
                } else if (action.type === 'quadrada') {
                    ctx.rect(action.x - action.size, action.y - action.size, action.size * 2, action.size * 2);
                } else if (action.type === 'retangular') {
                    ctx.rect(action.x - (action.size * 1.5), action.y - action.size, action.size * 3, action.size * 2);
                }
                ctx.fill();
                ctx.stroke();
            }
        }
        function undoLastAction() {
            drawingHistory.pop();
            redrawCanvas();
            console.log("Última ação desfeita.");
        }
        function clearDrawings() {
            drawingHistory = [];
            redrawCanvas();
            console.log("Desenhos limpos.");
        }

        // --- Função para Fundir e Submeter o Formulário ---
        function submitForm() {
            const form = document.getElementById('review-form');
            const hiddenInput = document.getElementById('imagem_desenhada');
            
            if (canvas && imagem) {
                console.log("A fundir imagem e canvas...");
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = imagem.naturalWidth;
                tempCanvas.height = imagem.naturalHeight;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(imagem, 0, 0);
                
                const scaleX = imagem.naturalWidth / imagem.clientWidth;
                const scaleY = imagem.naturalHeight / imagem.clientHeight;
                
                tempCtx.fillStyle = "#FF0000A0";
                tempCtx.strokeStyle = "#000000";
                tempCtx.lineWidth = 2 * scaleX;

                for (const action of drawingHistory) {
                    const x = action.x * scaleX;
                    const y = action.y * scaleY;
                    const size = action.size * scaleX;

                    tempCtx.beginPath();
                    if (action.type === 'redonda') {
                        tempCtx.arc(x, y, size, 0, 2 * Math.PI);
                    } else if (action.type === 'quadrada') {
                        tempCtx.rect(x - size, y - size, size * 2, size * 2);
                    } else if (action.type === 'retangular') {
                        tempCtx.rect(x - (size * 1.5), y - size, size * 3, size * 2);
                    }
                    tempCtx.fill();
                    tempCtx.stroke();
                }
                
                const dataURL = tempCanvas.toDataURL('image/png');
                hiddenInput.value = dataURL;
                console.log("Imagem desenhada foi guardada no formulário.");
            }
            
            form.submit();
        }
    </script>
{% endblock %}
